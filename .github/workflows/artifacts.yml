name: Build Artifacts

on:
  push:
    branches: [ optsched ]

jobs:
  update-release-tag:
    runs-on: ubuntu-20.04

    steps:
    - uses: marvinpinto/action-automatic-releases@1369002240ebd4f758bbc69e9ae3649a5c3c2e14
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        automatic_release_tag: optsched-artifacts
        prerelease: false

  build-llvm:
    runs-on: ubuntu-20.04
    needs: update-release-tag

    strategy:
      matrix:
        asserts: [OFF, ON]
        include:
          - asserts: OFF
            artifact: llvm-release
          - asserts: ON
            artifact: llvm-release-asserts

    steps:
    - uses: actions/checkout@v2
    - name: Configure
      run: |
        mkdir build && cd build
        cmake ../llvm                                       \
            -DCMAKE_BUILD_TYPE=Release                      \
            -DCMAKE_PARALLEL_LINK_JOBS=1                    \
            -DCMAKE_INSTALL_PREFIX=$(cd ..; pwd)/install    \
            -DLLVM_ENABLE_PROJECTS='clang'                  \
            -DLLVM_TARGETS_TO_BUILD=X86                     \
            -DLLVM_INCLUDE_TESTS=ON                         \
            -DLLVM_OPTIMIZED_TABLEGEN=ON                    \
            -DLLVM_ENABLE_ASSERTIONS=${{ matrix.asserts }}

    - name: Build
      working-directory: build
      run: |
        make -j4 || true
        make -j4 || true
        make -j4 || true
        make -j4 || true
        make

    - name: Install
      working-directory: build
      run: |
        make install

    - uses: meeDamian/github-release@2.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: optsched-artifacts
        commitish: optsched
        name: OptSched Artifacts
        body: |
          For pre-built LLVM binaries / libraries / include files, configured for OptSched
        files: ${{ matrix.artifact }}:./install
        gzip: true
        allow_override: true

  build-amdgpu-llvm:
    runs-on: ubuntu-20.04
    needs: update-release-tag

    strategy:
      matrix:
        asserts: [OFF, ON]
        include:
          - asserts: OFF
            artifact: amdgpu-llvm-release
          - asserts: ON
            artifact: amdgpu-llvm-release-asserts

    steps:
    - name: Install dependencies
      run: |
        # Setup ROCm Key
        wget -q -O - https://repo.radeon.com/rocm/rocm.gpg.key | sudo apt-key add -
        echo 'deb [arch=amd64] https://repo.radeon.com/rocm/apt/debian/ xenial main' | sudo tee /etc/apt/sources.list.d/rocm.list

        sudo apt-get update

        # Install ROCm
        sudo apt install rocm-dkms

    - name: Build Clang
      run: |
        git clone https://github.com/llvm/llvm-project
        cd llvm-project
        mkdir build && cd build
        cmake -DLLVM_ENABLE_PROJECTS='clang' -DCMAKE_BUILD_TYPE=Release -DLLVM_TARGETS_TO_BUILD=X86 \
          -DLLVM_BUILD_TOOLS=ON -DLLVM_OPTIMIZED_TABLEGEN=ON ../llvm

        make -j4

    - name: Set Up Repo Tool
      run: |
        mkdir -p $GITHUB_WORKSPACE/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > $GITHUB_WORKSPACE/bin/repo
        chmod a+x $GITHUB_WORKSPACE/bin/repo

    - name: Get ROCm
      run: |
        ./bin/repo init -u https://github.com/RadeonOpenCompute/ROCm-OpenCL-Runtime.git -b roc-2.4.x -m opencl.xml
        ./bin/repo sync

    - name: Patch ROCm
      run: |
        sed -Ei '/local:/d' opencl/api/opencl/amdocl/amdocl.map
        wget https://raw.githubusercontent.com/Quincunx271/llvm-project/${{ github.sha }}/.github/amdgpu-opencl.patch
        cd opencl/compiler/driver && git apply $GITHUB_WORKSPACE/amdgpu-opencl.patch

    - name: Configure
      run: |
        mkdir build && cd build
        cmake ../opencl                                                             \
            -DCMAKE_BUILD_TYPE=Release                                              \
            -DCMAKE_CXX_COMPILER=$GITHUB_WORKSPACE/llvm-project/build/bin/clang++   \
            -DCMAKE_PARALLEL_LINK_JOBS=1                                            \
            -DCMAKE_INSTALL_PREFIX=$(cd ..; pwd)/install                            \
            -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU"                                    \
            -DLLVM_BUILD_TOOLS=ON                                                   \
            -DLLVM_INCLUDE_TESTS=ON                                                 \
            -DCLANG_ENABLE_STATIC_ANALYZER=ON                                       \
            -DLLVM_ENABLE_ASSERTIONS=${{ matrix.asserts }}

    - name: Build
      working-directory: build
      run: |
        make -j4 || true
        make -j4 || true
        make -j4 || true
        make -j4 || true
        make

    - name: Install
      run: |
        (cd build && make install)
        cp -r opencl/compiler/llvm/lib/Target/AMDGPU/ install/include-private
        cp build/compiler/llvm/lib/Target/AMDGPU/*.inc install/include-private/

    - uses: meeDamian/github-release@2.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: optsched-artifacts
        commitish: optsched
        name: OptSched Artifacts
        body: |
          For pre-built LLVM binaries / libraries / include files, configured for OptSched
        files: ${{ matrix.artifact }}:./install
        gzip: true
        allow_override: true
